{
  "contentVersion": "1.0.0.0",
  "parameters": {
    "workbookDisplayName": {
      "type": "string",
      "defaultValue": "Entra Identity Protection Risk Hunting",
      "metadata": {
        "description": "The friendly name for the workbook that is used in the Gallery or Saved List.  This name must be unique within a resource group."
      }
    },
    "workbookType": {
      "type": "string",
      "defaultValue": "sentinel",
      "metadata": {
        "description": "The gallery that the workbook will been shown under. If you want this in the Sentinel gallery, keep the default as sentinel."
      }
    },
    "workbookSourceId": {
      "type": "string",
      "metadata": {
        "description": "The resource id of your workspace (will be a full path containing the RG and subscription)"
      }
    },
    "workbookId": {
      "type": "string",
      "defaultValue": "[newGuid()]",
      "metadata": {
        "description": "The unique guid for this workbook instance"
      }
    }
  },
  "resources": [
    {
      "name": "[parameters('workbookId')]",
      "type": "microsoft.insights/workbooks",
      "location": "[resourceGroup().location]",
      "apiVersion": "2022-04-01",
      "dependsOn": [],
      "kind": "shared",
      "properties": {
        "displayName": "[parameters('workbookDisplayName')]",
        "serializedData": "{\"version\":\"Notebook/1.0\",\"items\":[{\"type\":1,\"content\":{\"json\":\"## Risk Hunting\\nThe password guessed column checks whether a conditional access policy was applied to determine whether the password was checked.  \\nPerform additional investigation to validate that data. The error code and failure status are subject to change, to check the error code please use: https://login.microsoftonline.com/error.  \\nTo start using this workbook, select a time range. To pivot between users, select on a username.\"},\"name\":\"text - 2\"},{\"type\":9,\"content\":{\"version\":\"KqlParameterItem/1.0\",\"parameters\":[{\"id\":\"cf1c7c4e-7f9e-4c3a-a376-a7a56be54f3c\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"Timerange\",\"type\":4,\"description\":\"Choose a time range to hunt through\",\"isRequired\":true,\"typeSettings\":{\"selectableValues\":[{\"durationMs\":3600000},{\"durationMs\":86400000},{\"durationMs\":604800000},{\"durationMs\":2592000000},{\"durationMs\":5184000000},{\"durationMs\":7776000000}],\"allowCustom\":true},\"timeContext\":{\"durationMs\":86400000},\"value\":{\"durationMs\":2592000000}},{\"id\":\"5bd5ea9e-d9a2-49a3-8455-1616b0c97b5d\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"RiskState\",\"label\":\"Risk State\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"AADRiskyUsers\\r\\n| where TimeGenerated between (ago(90d)..now())\\r\\n| summarize by RiskState\",\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"Timerange\",\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},{\"id\":\"05639ec3-94d1-4673-9566-710e629c2217\",\"version\":\"KqlParameterItem/1.0\",\"name\":\"RiskLevel\",\"label\":\"Risk Level\",\"type\":2,\"isRequired\":true,\"multiSelect\":true,\"quote\":\"'\",\"delimiter\":\",\",\"query\":\"AADRiskyUsers\\r\\n| summarize by RiskLevel\",\"typeSettings\":{\"additionalResourceOptions\":[\"value::all\"],\"showDefault\":false},\"timeContext\":{\"durationMs\":0},\"timeContextFromParameter\":\"Timerange\",\"defaultValue\":\"value::all\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"}],\"style\":\"pills\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"name\":\"parameters - 4\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AADRiskyUsers\\n| summarize arg_max(TimeGenerated,*) by UserDisplayName\\n| where isnull(RiskState) or RiskState in ({RiskState})\\n| where isnull(RiskLevel) or RiskLevel in ({RiskLevel})\\n| project UserDisplayName, RiskLevel, Id, RiskDetail, RiskState, UserPrincipalName\\n| order by RiskLevel\",\"size\":1,\"timeContextFromParameter\":\"Timerange\",\"exportFieldName\":\"Id\",\"exportParameterName\":\"UserId\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"formatters\":[{\"columnMatch\":\"RiskLevel\",\"formatter\":18,\"formatOptions\":{\"thresholdsOptions\":\"icons\",\"thresholdsGrid\":[{\"operator\":\"contains\",\"thresholdValue\":\"low\",\"representation\":\"Sev2\",\"text\":\"{0}{1}\"},{\"operator\":\"contains\",\"thresholdValue\":\"medium\",\"representation\":\"Sev1\",\"text\":\"{0}{1}\"},{\"operator\":\"contains\",\"thresholdValue\":\"high\",\"representation\":\"Sev0\",\"text\":\"{0}{1}\"},{\"operator\":\"Default\",\"thresholdValue\":null,\"representation\":\"Sev2\",\"text\":\"{0}{1}\"}]}}],\"filter\":true}},\"customWidth\":\"70\",\"conditionalVisibility\":{\"parameterName\":\"Timerange\",\"comparison\":\"isNotEqualTo\"},\"name\":\"Risky Users\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AADRiskyUsers\\r\\n| summarize arg_max(TimeGenerated,*) by UserDisplayName\\r\\n| summarize count() by RiskLevel\",\"size\":1,\"timeContextFromParameter\":\"Timerange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"piechart\",\"chartSettings\":{\"seriesLabelSettings\":[{\"seriesName\":\"low\",\"color\":\"yellow\"},{\"seriesName\":\"high\",\"color\":\"redBright\"},{\"seriesName\":\"none\",\"color\":\"gray\"},{\"seriesName\":\"medium\",\"color\":\"orange\"}]}},\"customWidth\":\"30\",\"name\":\"query - 5\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"User Info\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AADRiskyUsers\\r\\n| where Id== \\\"{UserId}\\\"\\r\\n| extend risk = strcat(RiskLevel,\\\": \\\", RiskState)\\r\\n| make-series dcount(Id) on TimeGenerated from {Timerange:start} to {Timerange:end} step 1d by risk\",\"size\":1,\"title\":\"Risk History\",\"timeContextFromParameter\":\"Timerange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"unstackedbar\"},\"name\":\"Risk History\"},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let interactive=SigninLogs\\r\\n| where array_length(todynamic(RiskEventTypes)) >0 or AuthenticationDetails has \\\"suspicious\\\"\\r\\n| where UserId== \\\"{UserId}\\\"\\r\\n| extend\\r\\n    DeviceDetail = todynamic(DeviceDetail),\\r\\n    LocationDetails = todynamic(LocationDetails),\\r\\n    MfaDetail = todynamic(MfaDetail),\\r\\n    FraudReported= iff(AuthenticationDetails has \\\"suspicious\\\", \\\"Yes\\\", \\\"No\\\")\\r\\n| extend\\r\\n    OS = tostring(DeviceDetail.operatingSystem),\\r\\n    Browser = tostring(DeviceDetail.browser),\\r\\n    State = tostring(LocationDetails.state),\\r\\n    City = tostring(LocationDetails.city),\\r\\n    Region = tostring(LocationDetails.countryOrRegion),\\r\\n    MfaMethod = tostring(MfaDetail.authMethod)\\r\\n| extend FailureOrSuccess = iff(ResultType in (\\\"0\\\", \\\"50125\\\", \\\"50140\\\", \\\"70043\\\", \\\"70044\\\"), \\\"Success\\\", \\\"Failure\\\"),\\r\\nfailureReason = iff(isnotempty(todynamic(Status).failureReason),todynamic(Status).failureReason, \\\"\\\") \\r\\n| extend PasswordLikelyGuessed = iff(ConditionalAccessStatus !has \\\"notapplied\\\" or FailureOrSuccess == \\\"Success\\\", \\\"Yes\\\", \\\"No\\\")\\r\\n| project ActivityTime=CreatedDateTime, UserPrincipalName, Identity, PasswordLikelyGuessed,FailureOrSuccess,FraudReported, failureReason, ConditionalAccessStatus, AppDisplayName, City, State, Region,MfaMethod, RiskLevelDuringSignIn, RiskDetail,RiskState,UserAgent, RiskCount = array_length(todynamic(RiskEventTypes)), RiskEventTypes;\\r\\nlet noninteractive=AADNonInteractiveUserSignInLogs\\r\\n| where array_length(todynamic(RiskEventTypes)) >0\\r\\n| where UserId== \\\"{UserId}\\\"\\r\\n| extend\\r\\n    DeviceDetail = todynamic(DeviceDetail),\\r\\n    LocationDetails = todynamic(LocationDetails),\\r\\n    MfaDetail = todynamic(MfaDetail),\\r\\n    FraudReported= iff(AuthenticationDetails has \\\"suspicious\\\", \\\"Yes\\\", \\\"No\\\")\\r\\n| extend\\r\\n    OS = tostring(DeviceDetail.operatingSystem),\\r\\n    Browser = tostring(DeviceDetail.browser),\\r\\n    State = tostring(LocationDetails.state),\\r\\n    City = tostring(LocationDetails.city),\\r\\n    Region = tostring(LocationDetails.countryOrRegion),\\r\\n    MfaMethod = tostring(MfaDetail.authMethod)\\r\\n| extend FailureOrSuccess = iff(ResultType in (\\\"0\\\", \\\"50125\\\", \\\"50140\\\", \\\"70043\\\", \\\"70044\\\"), \\\"Success\\\", \\\"Failure\\\"),\\r\\nfailureReason = iff(isnotempty(todynamic(Status).failureReason),todynamic(Status).failureReason, \\\"\\\") \\r\\n| extend PasswordLikelyGuessed = iff(ConditionalAccessStatus !has \\\"notapplied\\\" or FailureOrSuccess == \\\"Success\\\", \\\"Yes\\\", \\\"No\\\")\\r\\n| project ActivityTime=CreatedDateTime, UserPrincipalName, Identity, PasswordLikelyGuessed,FailureOrSuccess,FraudReported, failureReason, ConditionalAccessStatus, AppDisplayName, City, State, Region,MfaMethod, RiskLevelDuringSignIn, RiskDetail,RiskState,UserAgent, RiskCount = array_length(todynamic(RiskEventTypes)), RiskEventTypes;\\r\\ninteractive\\r\\n| union noninteractive\",\"size\":0,\"title\":\"Risky Sign-Ins\",\"noDataMessage\":\"No risks found for selected user within selected timeframe\",\"timeContextFromParameter\":\"Timerange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"gridSettings\":{\"filter\":true}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"UserId\",\"comparison\":\"isNotEqualTo\"},\"name\":\"Risky Sign-Ins\",\"styleSettings\":{\"maxWidth\":\"50\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"let interactive=SigninLogs\\r\\n| where array_length(todynamic(RiskEventTypes)) >0\\r\\n| where UserId== \\\"{UserId}\\\"\\r\\n| where array_length(todynamic(RiskEventTypes)) >0\\r\\n| extend FailureOrSuccess = iff(ResultType in (\\\"0\\\", \\\"50125\\\", \\\"50140\\\", \\\"70043\\\", \\\"70044\\\"), \\\"Success\\\", \\\"Failure\\\"),\\r\\nfailureReason = iff(isnotempty(todynamic(Status).failureReason),todynamic(Status).failureReason, \\\"\\\") \\r\\n| extend PasswordLikelyGuessed = iff(ConditionalAccessStatus !has \\\"notapplied\\\" or FailureOrSuccess == \\\"Success\\\", \\\"Yes\\\", \\\"No\\\")\\r\\n| extend LocationDetails = parse_json(LocationDetails)\\r\\n| project longitude = LocationDetails.geoCoordinates.longitude, latitude = LocationDetails.geoCoordinates.latitude, PasswordLikelyGuessed, UserPrincipalName;\\r\\nlet noninteractive=AADNonInteractiveUserSignInLogs\\r\\n| where array_length(todynamic(RiskEventTypes)) >0\\r\\n| where UserId== \\\"{UserId}\\\"\\r\\n| where array_length(todynamic(RiskEventTypes)) >0\\r\\n| extend FailureOrSuccess = iff(ResultType in (\\\"0\\\", \\\"50125\\\", \\\"50140\\\", \\\"70043\\\", \\\"70044\\\"), \\\"Success\\\", \\\"Failure\\\"),\\r\\nfailureReason = iff(isnotempty(todynamic(Status).failureReason),todynamic(Status).failureReason, \\\"\\\") \\r\\n| extend PasswordLikelyGuessed = iff(ConditionalAccessStatus !has \\\"notapplied\\\" or FailureOrSuccess == \\\"Success\\\", \\\"Yes\\\", \\\"No\\\")\\r\\n| extend LocationDetails = parse_json(LocationDetails)\\r\\n| project longitude = LocationDetails.geoCoordinates.longitude, latitude = LocationDetails.geoCoordinates.latitude, PasswordLikelyGuessed, UserPrincipalName;\\r\\ninteractive\\r\\n| union noninteractive\",\"size\":0,\"noDataMessage\":\"No risks found for selected user within selected timeframe\",\"timeContextFromParameter\":\"Timerange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"map\",\"mapSettings\":{\"locInfo\":\"LatLong\",\"latitude\":\"latitude\",\"longitude\":\"longitude\",\"sizeAggregation\":\"Sum\",\"labelSettings\":\"UserPrincipalName\",\"legendMetric\":\"UserPrincipalName\",\"legendAggregation\":\"Count\",\"itemColorSettings\":null}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"UserId\",\"comparison\":\"isNotEqualTo\"},\"name\":\"User Risk Sign-ins Geolocation\",\"styleSettings\":{\"maxWidth\":\"50\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AADUserRiskEvents\\r\\n|where UserId== \\\"{UserId}\\\"\\r\\n| where Activity != \\\"signin\\\"\\r\\n| extend\\r\\n    DeviceDetail = todynamic(todynamic(AdditionalInfo)[0].Value),\\r\\n    Location = todynamic(Location)\\r\\n| extend\\r\\n    Browser = tostring(DeviceDetail),\\r\\n    State = tostring(Location.state),\\r\\n    City = tostring(Location.city),\\r\\n    Region = tostring(Location.countryOrRegion)\\r\\n| project ActivityDateTime, Activity, Region, City, UserPrincipalName, UserDisplayName, RiskEventType, RiskLevel, RiskState, DetectionTimingType, DeviceDetail \",\"size\":0,\"title\":\"Non Sign-In Risk Events\",\"noDataMessage\":\"No Non Sign-in Risk Events Found\",\"timeContextFromParameter\":\"Timerange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"customWidth\":\"50\",\"name\":\"Non Sign-in Risk Events\"},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"AADUserRiskEvents\\r\\n|where UserId== \\\"{UserId}\\\"\\r\\n| where Activity != \\\"signin\\\"\\r\\n| extend\\r\\n    DeviceDetail = todynamic(todynamic(AdditionalInfo)[0].Value),\\r\\n    Location = todynamic(Location)\\r\\n| extend\\r\\n    Browser = tostring(DeviceDetail),\\r\\n    State = tostring(Location.state),\\r\\n    City = tostring(Location.city),\\r\\n    Region = tostring(Location.countryOrRegion)\\r\\n| project UserPrincipalName, longitude = Location.geoCoordinates.longitude, latitude = Location.geoCoordinates.latitude,Activity, RiskEventType, CorrelationId\",\"size\":0,\"noDataMessage\":\"No risks found for selected user within selected timeframe\",\"timeContextFromParameter\":\"Timerange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"map\",\"mapSettings\":{\"locInfo\":\"LatLong\",\"latitude\":\"latitude\",\"longitude\":\"longitude\",\"sizeAggregation\":\"Sum\",\"labelSettings\":\"UserPrincipalName\",\"legendMetric\":\"CorrelationId\",\"legendAggregation\":\"Count\",\"itemColorSettings\":null}},\"customWidth\":\"50\",\"conditionalVisibility\":{\"parameterName\":\"UserId\",\"comparison\":\"isNotEqualTo\"},\"name\":\"User Risk Sign-ins Geolocation - Copy\",\"styleSettings\":{\"maxWidth\":\"50\"}}]},\"name\":\"Risk Events\",\"styleSettings\":{\"showBorder\":true}},{\"type\":12,\"content\":{\"version\":\"NotebookGroup/1.0\",\"groupType\":\"editable\",\"title\":\"User Alerts\",\"items\":[{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityAlert\\r\\n| where Entities has \\\"{UserId}\\\"\\r\\n| summarize arg_max(TimeGenerated, *) by SystemAlertId\",\"size\":0,\"noDataMessage\":\"No alerts found with that user for the selected timeframe\",\"timeContextFromParameter\":\"Timerange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\"},\"customWidth\":\"50\",\"name\":\"User Alerts\",\"styleSettings\":{\"maxWidth\":\"50\"}},{\"type\":3,\"content\":{\"version\":\"KqlItem/1.0\",\"query\":\"SecurityAlert\\r\\n| where Entities has \\\"{UserId}\\\"\\r\\n| make-series dcount(SystemAlertId) on TimeGenerated from {Timerange:start} to {Timerange:end} step 1d by AlertSeverity\",\"size\":0,\"title\":\"User Alerts\",\"noDataMessage\":\"No alerts found with that user for the selected timeframe\",\"timeContextFromParameter\":\"Timerange\",\"queryType\":0,\"resourceType\":\"microsoft.operationalinsights/workspaces\",\"visualization\":\"unstackedbar\",\"chartSettings\":{\"xAxis\":\"TimeGenerated\",\"showLegend\":true,\"seriesLabelSettings\":[{\"seriesName\":\"Medium\",\"color\":\"orange\"},{\"seriesName\":\"High\",\"color\":\"redBright\"},{\"seriesName\":\"Low\",\"color\":\"yellow\"}],\"xSettings\":{\"label\":\"Time\"}}},\"customWidth\":\"50\",\"name\":\"User Alerts - Copy\",\"styleSettings\":{\"maxWidth\":\"50\"}}]},\"name\":\"User Alerts\",\"styleSettings\":{\"showBorder\":true}}]},\"conditionalVisibility\":{\"parameterName\":\"UserId\",\"comparison\":\"isNotEqualTo\"},\"name\":\"User Info\"}],\"isLocked\":false,\"fallbackResourceIds\":[\"/subscriptions/9e012d06-4193-46e1-9f1b-28ff82b09eae/resourcegroups/securityoperations/providers/microsoft.operationalinsights/workspaces/primarysecops\"],\"styleSettings\":{\"spacingStyle\":\"narrow\"},\"fromTemplateId\":\"sentinel-UserWorkbook\"}",
        "version": "1.0",
        "sourceId": "[parameters('workbookSourceId')]",
        "category": "[parameters('workbookType')]"
      }
    }
  ],
  "outputs": {
    "workbookId": {
      "type": "string",
      "value": "[resourceId( 'microsoft.insights/workbooks', parameters('workbookId'))]"
    }
  },
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#"
}
